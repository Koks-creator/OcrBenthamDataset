{% extends 'layout.html' %}

{% block content %}
<div class="container text-center">
  <br>
  <br>
  <div class="jumbotron position-relative" style="background-color: #212529;">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flashes">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                {{ message }}
                </div>
            {% endfor %}
            </div>
        {% endif %}
      {% endwith %}

    <!-- Loading Spinner (hidden by default) -->
    <div id="loadingSpinner" class="spinner-container" style="display: none;">
      <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-light">Processing images, please wait...</p>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <div class="upload-card">
        <div class="upload-header">
          <div class="upload-icon">üìÑ</div>
          <h2 class="upload-title">Upload Your Images</h2>
          <p class="upload-subtitle">Select one or more images containing handwritten text</p>
        </div>
        
        <form id="uploadForm" method="post" enctype="multipart/form-data">
          {{ form.hidden_tag() }}
          <div class="upload-body">
            <div class="file-input-wrapper">
              {% if form.images.errors %}
                {{ form.images(class='form-control form-control-lg is-invalid', multiple=True, id='fileInput') }}
                {% for error in form.images.errors %}
                  <div class="text-danger mt-2">{{ error }}</div>
                {% endfor %}
              {% else %}
                {{ form.images(class='form-control form-control-lg', multiple=True, id='fileInput') }}
              {% endif %}
              <div class="file-hint">
                <span>üí°</span> Supported formats: JPG, PNG, BMP, TIFF
              </div>
            </div>
            
            <div class="upload-actions">
              {{ form.submit(class='btn-upload') }}
            </div>
          </div>
        </form>
      </div>
      
      <!-- Info Button -->
      <div class="info-toggle-wrapper">
        <button type="button" class="info-toggle-btn" data-bs-toggle="collapse" data-bs-target="#modelInfo" aria-expanded="false">
          <span class="info-icon">‚ÑπÔ∏è</span>
          <span>About this OCR model</span>
          <span class="chevron">‚ñº</span>
        </button>
      </div>
    </div>

    <!-- Model Info Section (Collapsible) -->
    <div class="collapse" id="modelInfo">
      <div class="model-info-section">
        <div class="info-grid">
          
          <div class="info-card">
            <div class="info-card-icon">üß†</div>
            <h3>Model Architecture</h3>
            <p>
              This OCR system uses a deep learning model based on CNN and RNN layers with Connectionist Temporal Classification loss function to
              extract text from cropped text lines - these text line are detected by Yolov11 object detection model.
            </p>
          </div>
          
          <div class="info-card">
            <div class="info-card-icon">üìö</div>
            <h3>Training Data</h3>
            <p>
              The model was trained on the <a href="https://zenodo.org/records/44519">Bentham dataset</a> which is a collection 
              consists of a set of images of a collection of works on law and moral philosophy written by the philosopher Jeremy Bentham.
            </p>
          </div>
          
          <div class="info-card">
            <div class="info-card-icon">‚öôÔ∏è</div>
            <h3>How It Works</h3>
            <p>
              When uploading images our Yolov11 object detection model detects text lines,
              draws boxes around them, crops text lines and store them. Stored images of cropped text lines
              are loaded to the OCR model, so the actual text can be extracted and return results.
            </p>
          </div>
          
          <div class="info-card">
            <div class="info-card-icon">‚ö†Ô∏è</div>
            <h3>Limitations</h3>
            <p>
              This model was trained on historical papers, which are quite specific, so it's not gonna perform well on modern ones.
            </p>
          </div>
          
        </div>
        </div>
      </div>
    </div>

    {% if results and image_filenames %}
    
      <!-- Results Section - Side by Side Layout -->
      <div class="ocr-results-wrapper mt-4">
        <div class="ocr-results-grid">
          
          <!-- Left: Text Results -->
          <div class="ocr-text-panel">
            <div class="panel-header">
              <span class="panel-title">üìù Extracted text</span>
              <div class="panel-actions">
                <span id="charCount" class="char-count"></span>
                <button id="copyBtn" class="copy-btn" title="Copy to clipboard">
                  <span class="copy-icon">üìã</span>
                  <span class="copy-text">Copy</span>
                </button>
              </div>
            </div>
            <div id="resultsBox" class="results-box">{% for i in range(results | length) %}<strong>{{ image_filenames[i] }}</strong> <br><br> {{ results[i] }}<br>{% if not loop.last %}
{% endif %}{% endfor %}</div>
          </div>
          
          <!-- Right: Image Preview -->
          <div class="ocr-image-panel">
            <div class="panel-header">
              <span class="panel-title">üñºÔ∏è Images</span>
              <div class="panel-actions">
                <span id="imageCounter" class="image-counter">1 / {{ image_filenames|length }}</span>
                {% if image_filenames|length > 1 %}
                <button id="prevThumb" class="nav-btn" title="Previous">‚ùÆ</button>
                <button id="nextThumb" class="nav-btn" title="Next">‚ùØ</button>
                {% endif %}
              </div>
            </div>
            <div class="image-preview-container">
              <img id="previewImg" 
                   src="{{ url_for('static', filename='temp_uploads/' ~ image_filenames[0]) }}" 
                   class="preview-image"
                   title="Click to enlarge">
              
              {% if image_filenames|length > 1 %}
              <div class="thumbnails-strip">
                {% for image_filename in image_filenames %}
                <img src="{{ url_for('static', filename='temp_uploads/' ~ image_filename) }}" 
                     class="thumbnail {% if loop.first %}active{% endif %}"
                     data-index="{{ loop.index0 }}"
                     data-full="{{ url_for('static', filename='temp_uploads/' ~ image_filename) }}">
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
          
        </div>
        
        <!-- Download JSON Button -->
        <div class="download-section mt-4">
          <button id="downloadJsonBtn" class="download-json-btn" title="Download the results as a JSON">
            <span class="download-icon">üì•</span>
            <span class="download-text">Download results (JSON)</span>
          </button>
        </div>
        
      </div>

    {% endif %}
  </div>
</div>

<!-- Custom Lightbox -->
<div id="lightbox" class="lightbox-overlay">
  <div class="lightbox-controls">
    <div class="zoom-controls">
      <button id="zoomOut" class="lb-btn" title="Zoom out (-)">‚àí</button>
      <span id="zoomLevel" class="zoom-indicator">100%</span>
      <button id="zoomIn" class="lb-btn" title="Zoom in (+)">+</button>
      <button id="zoomReset" class="lb-btn" title="Reset (0)">‚ü≤</button>
    </div>
    <div class="nav-controls">
      <button id="prevImg" class="lb-btn" title="Previous (‚Üê)">‚ùÆ</button>
      <span id="imgCounter" class="img-counter">1 / 1</span>
      <button id="nextImg" class="lb-btn" title="Next (‚Üí)">‚ùØ</button>
    </div>
    <div class="action-controls">
      <button id="downloadImg" class="lb-btn" title="Download">‚¨á</button>
      <button id="closeLightbox" class="lb-btn" title="Close (Esc)">‚úï</button>
    </div>
  </div>
  
  <div class="lightbox-content">
    <div id="imageContainer" class="image-container">
      <img id="lightboxImg" src="" alt="Preview">
    </div>
  </div>
  
  <div class="zoom-hint" id="zoomHint">
    Use the mouse wheel or the +/- buttons to zoom in.
  </div>
</div>

<!-- JSON Data for Download -->
{% if json_res %}
<script id="jsonData" type="application/json">
  {{ json_res | tojson | safe }}
</script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // =====================
  // COPY FUNCTIONALITY
  // =====================
  const copyBtn = document.getElementById('copyBtn');
  const resultsBox = document.getElementById('resultsBox');
  const charCount = document.getElementById('charCount');
  
  if (resultsBox && charCount) {
    const text = resultsBox.textContent;
    const chars = text.length;
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    charCount.textContent = `${chars} chars / ${words} words`;
  }
  
  if (copyBtn && resultsBox) {
    copyBtn.addEventListener('click', async () => {
      const text = resultsBox.textContent;
      
      try {
        await navigator.clipboard.writeText(text);
        showCopySuccess();
      } catch (err) {
        const range = document.createRange();
        range.selectNodeContents(resultsBox);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        document.execCommand('copy');
        selection.removeAllRanges();
        showCopySuccess();
      }
    });
    
    function showCopySuccess() {
      const icon = copyBtn.querySelector('.copy-icon');
      const text = copyBtn.querySelector('.copy-text');
      
      copyBtn.classList.add('copied');
      icon.textContent = '‚úì';
      text.textContent = 'Copied!';
      
      setTimeout(() => {
        copyBtn.classList.remove('copied');
        icon.textContent = 'üìã';
        text.textContent = 'Copy';
      }, 2000);
    }
  }

  // =====================
  // DOWNLOAD JSON FUNCTIONALITY
  // =====================
  const downloadJsonBtn = document.getElementById('downloadJsonBtn');
  const jsonDataElement = document.getElementById('jsonData');
  
  if (downloadJsonBtn && jsonDataElement) {
    downloadJsonBtn.addEventListener('click', () => {
      try {
        const jsonData = JSON.parse(jsonDataElement.textContent);
        const jsonString = JSON.stringify(jsonData, null, 2);
        
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        
        const now = new Date();
        const dateStr = now.toISOString().slice(0, 19).replace(/[T:]/g, '-');
        link.download = `ocr_results_${dateStr}.json`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showDownloadSuccess();
        
      } catch (err) {
        console.error('Error downloading JSON:', err);
        alert('Error downloading JSON file');
      }
    });
    
    function showDownloadSuccess() {
      const icon = downloadJsonBtn.querySelector('.download-icon');
      const text = downloadJsonBtn.querySelector('.download-text');
      
      downloadJsonBtn.classList.add('downloaded');
      icon.textContent = '‚úì';
      text.textContent = 'Downloaded!';
      
      setTimeout(() => {
        downloadJsonBtn.classList.remove('downloaded');
        icon.textContent = 'üì•';
        text.textContent = 'Download results (JSON)';
      }, 2000);
    }
  }

  // =====================
  // INFO TOGGLE ANIMATION
  // =====================
  const infoToggle = document.querySelector('.info-toggle-btn');
  const modelInfo = document.getElementById('modelInfo');
  
  if (infoToggle && modelInfo) {
    modelInfo.addEventListener('show.bs.collapse', () => {
      infoToggle.classList.add('active');
    });
    modelInfo.addEventListener('hide.bs.collapse', () => {
      infoToggle.classList.remove('active');
    });
  }

  // =====================
  // THUMBNAIL NAVIGATION
  // =====================
  const thumbnails = document.querySelectorAll('.thumbnail');
  const previewImg = document.getElementById('previewImg');
  const imageCounter = document.getElementById('imageCounter');
  const prevThumb = document.getElementById('prevThumb');
  const nextThumb = document.getElementById('nextThumb');
  let currentThumbIndex = 0;
  
  function updatePreview(index) {
    if (thumbnails.length === 0) return;
    
    currentThumbIndex = index;
    const thumb = thumbnails[index];
    previewImg.src = thumb.dataset.full;
    
    thumbnails.forEach(t => t.classList.remove('active'));
    thumb.classList.add('active');
    
    if (imageCounter) {
      imageCounter.textContent = `${index + 1} / ${thumbnails.length}`;
    }
  }
  
  thumbnails.forEach((thumb, index) => {
    thumb.addEventListener('click', () => updatePreview(index));
  });
  
  if (prevThumb) {
    prevThumb.addEventListener('click', () => {
      const newIndex = (currentThumbIndex - 1 + thumbnails.length) % thumbnails.length;
      updatePreview(newIndex);
    });
  }
  
  if (nextThumb) {
    nextThumb.addEventListener('click', () => {
      const newIndex = (currentThumbIndex + 1) % thumbnails.length;
      updatePreview(newIndex);
    });
  }

  // =====================
  // LIGHTBOX FUNCTIONALITY
  // =====================
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightboxImg');
  const imageContainer = document.getElementById('imageContainer');
  const zoomLevel = document.getElementById('zoomLevel');
  const zoomHint = document.getElementById('zoomHint');
  const imgCounter = document.getElementById('imgCounter');
  
  if (!lightbox) return;
  
  const zoomLevels = [0.5, 0.75, 1, 1.25, 1.5, 2, 2.5, 3, 4, 5];
  let currentZoomIndex = 2;
  
  let images = [];
  let currentIndex = 0;
  let isDragging = false;
  let startX, startY, translateX = 0, translateY = 0;
  
  thumbnails.forEach((thumb) => {
    images.push(thumb.dataset.full);
  });
  
  if (images.length === 0 && previewImg) {
    images.push(previewImg.src);
  }
  
  if (previewImg) {
    previewImg.addEventListener('click', () => {
      openLightbox(currentThumbIndex);
    });
  }
  
  function openLightbox(index) {
    currentIndex = index;
    currentZoomIndex = 2;
    translateX = 0;
    translateY = 0;
    updateImage();
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
    setTimeout(() => zoomHint.classList.add('hidden'), 3000);
  }
  
  function closeLightbox() {
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
    zoomHint.classList.remove('hidden');
  }
  
  function updateImage() {
    lightboxImg.src = images[currentIndex];
    imgCounter.textContent = `${currentIndex + 1} / ${images.length}`;
    applyTransform();
  }
  
  function applyTransform() {
    const scale = zoomLevels[currentZoomIndex];
    imageContainer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    
    const percent = Math.round(scale * 100);
    zoomLevel.textContent = `${percent}%`;
    
    zoomLevel.className = 'zoom-indicator';
    if (scale <= 0.75) zoomLevel.classList.add('level-1');
    else if (scale <= 1) zoomLevel.classList.add('level-2');
    else if (scale <= 2) zoomLevel.classList.add('level-3');
    else if (scale <= 3) zoomLevel.classList.add('level-4');
    else zoomLevel.classList.add('level-5');
    
    if (scale <= 1) {
      translateX = 0;
      translateY = 0;
      imageContainer.style.transform = `scale(${scale})`;
    }
  }
  
  function zoomIn() {
    if (currentZoomIndex < zoomLevels.length - 1) {
      currentZoomIndex++;
      applyTransform();
    }
  }
  
  function zoomOut() {
    if (currentZoomIndex > 0) {
      currentZoomIndex--;
      applyTransform();
    }
  }
  
  function resetZoom() {
    currentZoomIndex = 2;
    translateX = 0;
    translateY = 0;
    applyTransform();
  }
  
  function nextImage() {
    currentIndex = (currentIndex + 1) % images.length;
    resetZoom();
    updateImage();
    updatePreview(currentIndex);
  }
  
  function prevImage() {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    resetZoom();
    updateImage();
    updatePreview(currentIndex);
  }
  
  function downloadImage() {
    const link = document.createElement('a');
    link.href = images[currentIndex];
    link.download = images[currentIndex].split('/').pop();
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
  
  document.getElementById('zoomIn').addEventListener('click', zoomIn);
  document.getElementById('zoomOut').addEventListener('click', zoomOut);
  document.getElementById('zoomReset').addEventListener('click', resetZoom);
  document.getElementById('nextImg').addEventListener('click', nextImage);
  document.getElementById('prevImg').addEventListener('click', prevImage);
  document.getElementById('downloadImg').addEventListener('click', downloadImage);
  document.getElementById('closeLightbox').addEventListener('click', closeLightbox);
  
  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox || e.target.classList.contains('lightbox-content')) {
      closeLightbox();
    }
  });
  
  lightbox.addEventListener('wheel', (e) => {
    e.preventDefault();
    if (e.deltaY < 0) zoomIn();
    else zoomOut();
  }, { passive: false });
  
  imageContainer.addEventListener('mousedown', (e) => {
    if (zoomLevels[currentZoomIndex] > 1) {
      isDragging = true;
      imageContainer.classList.add('dragging');
      startX = e.clientX - translateX;
      startY = e.clientY - translateY;
    }
  });
  
  document.addEventListener('mousemove', (e) => {
    if (isDragging) {
      translateX = e.clientX - startX;
      translateY = e.clientY - startY;
      applyTransform();
    }
  });
  
  document.addEventListener('mouseup', () => {
    isDragging = false;
    imageContainer.classList.remove('dragging');
  });
  
  document.addEventListener('keydown', (e) => {
    if (!lightbox.classList.contains('active')) return;
    
    switch(e.key) {
      case 'Escape': closeLightbox(); break;
      case 'ArrowRight': nextImage(); break;
      case 'ArrowLeft': prevImage(); break;
      case '+': case '=': zoomIn(); break;
      case '-': zoomOut(); break;
      case '0': resetZoom(); break;
      case 's': case 'S': downloadImage(); break;
    }
  });
  
  imageContainer.addEventListener('dblclick', () => {
    if (currentZoomIndex === 2) {
      currentZoomIndex = 5;
    } else {
      currentZoomIndex = 2;
      translateX = 0;
      translateY = 0;
    }
    applyTransform();
  });
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const spinner = document.getElementById('loadingSpinner');

    form.addEventListener('submit', function() {
      spinner.style.display = 'flex';
    });
  });
</script>
{% endblock content %}
